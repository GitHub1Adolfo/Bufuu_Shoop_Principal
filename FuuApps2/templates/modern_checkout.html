{% load static %}
{% load humanize %}

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/modern_base.css' %}">
    <link rel="stylesheet" href="{% static 'css/modern_navbar.css' %}">
    <link rel="stylesheet" href="{% static 'css/modern_checkout.css' %}">
    <title>Checkout - BuFuu GrowShop</title>
</head>

<body>
    {% include 'modern_navbar.html' %}
    
    <div class="checkout-page">
        <div class="checkout-container">
            <!-- Header -->
            <div class="checkout-header">
                <h1 class="checkout-title">üõí Finalizar Compra</h1>
                <p class="checkout-subtitle">Est√°s a un paso de completar tu pedido</p>
            </div>

            <!-- Steps Indicator -->
            <div class="checkout-steps">
                <div class="step completed">
                    <div class="step-number">‚úì</div>
                    <span class="step-label">Carrito</span>
                </div>
                <div class="step-divider"></div>
                <div class="step active">
                    <div class="step-number">2</div>
                    <span class="step-label">Informaci√≥n</span>
                </div>
                <div class="step-divider"></div>
                <div class="step">
                    <div class="step-number">3</div>
                    <span class="step-label">Pago</span>
                </div>
            </div>

            <!-- Main Content -->
            <div class="checkout-main">
                <!-- Left Column - Forms -->
                <div class="checkout-forms">
                    <form method="POST" action="{% url 'crear_pago' %}" id="checkoutForm">
                        {% csrf_token %}

                        <!-- Contact Information -->
                        <div class="form-section">
                            <div class="form-section-header">
                                <div class="form-section-icon">üìß</div>
                                <h2 class="form-section-title">Informaci√≥n de Contacto</h2>
                            </div>

                            <div class="form-row">
                                <div class="form-group-checkout">
                                    <label class="form-label-checkout">Nombre *</label>
                                    <input 
                                        type="text" 
                                        name="nombre"
                                        class="form-input-checkout" 
                                        placeholder="Tu nombre"
                                        value="{{ user.first_name }}"
                                        required
                                    >
                                </div>

                                <div class="form-group-checkout">
                                    <label class="form-label-checkout">Apellido *</label>
                                    <input 
                                        type="text" 
                                        name="apellido"
                                        class="form-input-checkout" 
                                        placeholder="Tu apellido"
                                        value="{{ user.last_name }}"
                                        required
                                    >
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group-checkout">
                                    <label class="form-label-checkout">Email *</label>
                                    <input 
                                        type="email" 
                                        name="email"
                                        class="form-input-checkout" 
                                        placeholder="tu@email.com"
                                        value="{{ user.email }}"
                                        required
                                    >
                                </div>

                                <div class="form-group-checkout">
                                    <label class="form-label-checkout">Tel√©fono *</label>
                                    <input 
                                        type="tel" 
                                        name="telefono"
                                        class="form-input-checkout" 
                                        placeholder="+56 9 XXXX XXXX"
                                        required
                                    >
                                </div>
                            </div>
                        </div>

                        <!-- Shipping Information -->
                        <div class="form-section">
                            <div class="form-section-header">
                                <div class="form-section-icon">üì¶</div>
                                <h2 class="form-section-title">Direcci√≥n de Env√≠o</h2>
                            </div>

                            <div class="form-group-checkout full">
                                <label class="form-label-checkout">Direcci√≥n Completa *</label>
                                <input 
                                    type="text" 
                                    name="direccion"
                                    class="form-input-checkout" 
                                    placeholder="Calle, n√∫mero, departamento"
                                    required
                                >
                            </div>

                            <div class="form-row">
                                <div class="form-group-checkout">
                                    <label class="form-label-checkout">Ciudad *</label>
                                    <input 
                                        type="text" 
                                        name="ciudad"
                                        class="form-input-checkout" 
                                        placeholder="Tu ciudad"
                                        required
                                    >
                                </div>

                                <div class="form-group-checkout">
                                    <label class="form-label-checkout">Regi√≥n *</label>
                                    <select name="region" class="form-select-checkout" required>
                                        <option value="">Selecciona regi√≥n</option>
                                        <option value="Regi√≥n Metropolitana">Regi√≥n Metropolitana</option>
                                        <option value="Arica y Parinacota">Arica y Parinacota</option>
                                        <option value="Tarapac√°">Tarapac√°</option>
                                        <option value="Antofagasta">Antofagasta</option>
                                        <option value="Atacama">Atacama</option>
                                        <option value="Coquimbo">Coquimbo</option>
                                        <option value="Valpara√≠so">Valpara√≠so</option>
                                        <option value="O'Higgins">O'Higgins</option>
                                        <option value="Maule">Maule</option>
                                        <option value="√ëuble">√ëuble</option>
                                        <option value="Biob√≠o">Biob√≠o</option>
                                        <option value="Araucan√≠a">Araucan√≠a</option>
                                        <option value="Los R√≠os">Los R√≠os</option>
                                        <option value="Los Lagos">Los Lagos</option>
                                        <option value="Ays√©n">Ays√©n</option>
                                        <option value="Magallanes">Magallanes</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group-checkout full">
                                <label class="form-label-checkout">Notas de Entrega (Opcional)</label>
                                <textarea 
                                    name="notas"
                                    class="form-textarea-checkout" 
                                    placeholder="Instrucciones especiales para la entrega..."
                                ></textarea>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="form-section">
                            <div class="form-section-header">
                                <div class="form-section-icon">üí≥</div>
                                <h2 class="form-section-title">M√©todo de Pago</h2>
                            </div>

                            <div class="payment-methods">
                                <label class="payment-method-option">
                                    <input type="radio" name="payment_method" value="mercadopago" checked>
                                    <div class="payment-method-card">
                                        <div class="payment-method-icon">üí≥</div>
                                        <div class="payment-method-info">
                                            <div class="payment-method-name">Mercado Pago</div>
                                            <div class="payment-method-description">Tarjetas y m√°s</div>
                                        </div>
                                    </div>
                                </label>

                                <label class="payment-method-option">
                                    <input type="radio" name="payment_method" value="transferencia">
                                    <div class="payment-method-card">
                                        <div class="payment-method-icon">üè¶</div>
                                        <div class="payment-method-info">
                                            <div class="payment-method-name">Transferencia</div>
                                            <div class="payment-method-description">Bancaria</div>
                                        </div>
                                    </div>
                                </label>

                                <label class="payment-method-option">
                                    <input type="radio" name="payment_method" value="efectivo">
                                    <div class="payment-method-card">
                                        <div class="payment-method-icon">üíµ</div>
                                        <div class="payment-method-info">
                                            <div class="payment-method-name">Efectivo</div>
                                            <div class="payment-method-description">Contra entrega</div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>

                    </form>
                </div>

                <!-- Right Column - Summary -->
                <aside class="checkout-summary">
                    <div class="summary-card">
                        <div class="summary-header">
                            <span class="summary-icon">üìã</span>
                            <h3 class="summary-title">Resumen</h3>
                        </div>

                        <!-- Items -->
                        <div class="summary-items">
                            {% for item in items %}
                            <div class="summary-item">
                                {% if item.producto.imagen %}
                                    <img src="{{ item.producto.imagen.url }}" alt="{{ item.producto.nombre }}" class="summary-item-image">
                                {% else %}
                                    <div class="summary-item-image" style="display: flex; align-items: center; justify-content: center; background: var(--bg-secondary);">üì¶</div>
                                {% endif %}

                                <div class="summary-item-details">
                                    <div class="summary-item-name">{{ item.producto.nombre }}</div>
                                    <div class="summary-item-quantity">Cantidad: {{ item.cantidad }}</div>
                                </div>

                                <div class="summary-item-price">
                                    ${{ item.total|floatformat:0|intcomma }}
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Totals -->
                        <div class="summary-totals">
                            <div class="summary-row">
                                <span class="summary-label">Subtotal:</span>
                                <span class="summary-value">${{ subtotal|floatformat:0|intcomma }}</span>
                            </div>

                            <div class="summary-row shipping">
                                <span class="summary-label">Env√≠o:</span>
                                <span class="summary-value">
                                    {% if envio == 0 %}
                                        Gratis
                                    {% else %}
                                        ${{ envio|floatformat:0|intcomma }}
                                    {% endif %}
                                </span>
                            </div>

                            <div class="summary-row total">
                                <span class="summary-label">Total:</span>
                                <span class="summary-value">${{ total|floatformat:0|intcomma }}</span>
                            </div>
                        </div>

                        <!-- Checkout Button -->
                        <button type="submit" form="checkoutForm" class="btn-checkout-submit" id="btnCheckout">
                            üí≥ Proceder al Pago
                        </button>

                        <!-- Security Badge -->
                        <div class="security-badge">
                            <span class="security-icon">üîí</span>
                            <span>Pago 100% seguro y protegido</span>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <!-- Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('checkoutForm');
            const btnCheckout = document.getElementById('btnCheckout');

            form.addEventListener('submit', function(e) {
                btnCheckout.classList.add('loading');
                btnCheckout.disabled = true;
                btnCheckout.innerHTML = '‚è≥ Procesando...';
            });

            // Validaci√≥n en tiempo real
            const requiredInputs = form.querySelectorAll('[required]');
            requiredInputs.forEach(input => {
                input.addEventListener('blur', function() {
                    if (!this.value) {
                        this.style.borderColor = '#ef4444';
                    } else {
                        this.style.borderColor = '';
                    }
                });

                input.addEventListener('input', function() {
                    if (this.value) {
                        this.style.borderColor = '#10b981';
                    }
                });
            });

            // Formatear tel√©fono
            const telInput = document.querySelector('input[name="telefono"]');
            if (telInput) {
                telInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 0) {
                        if (value.startsWith('56')) {
                            value = '+' + value;
                        } else if (!value.startsWith('+')) {
                            value = '+56' + value;
                        }
                    }
                    e.target.value = value;
                });
            }
        });
    </script>

</body>

</html>
