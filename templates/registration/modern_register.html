{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/modern_base.css' %}">
    <link rel="stylesheet" href="{% static 'css/modern_auth.css' %}">
    <title>Registrarse - BuFuu GrowShop</title>
</head>

<body>
    <div class="auth-page">
        <div class="auth-container">
            <!-- Logo Section -->
            <div class="auth-logo">
                <div class="auth-logo-img" style="font-size: 4rem;">üåø</div>
                <h1 class="auth-title"></h1>
                <p class="auth-subtitle">√önete a nuestra comunidad cann√°bica</p>
            </div>

            <!-- Error Messages -->
            {% if form.non_field_errors %}
                <div class="error-message">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Registration Form -->
            <form method="post" class="auth-form" id="registrationForm">
                {% csrf_token %}
                
                <!-- Username Field -->
                <div class="form-group {% if form.username.errors %}has-error{% endif %}">
                    <label for="id_username" class="form-label">Nombre de Usuario</label>
                    <div class="form-input-wrapper">
                        {{ form.username }}
                        <span class="form-icon">üë§</span>
                    </div>
                    {% if form.username.errors %}
                        {% for error in form.username.errors %}
                            <span class="form-error-message">{{ error }}</span>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- Email Field -->
                <div class="form-group {% if form.email.errors %}has-error{% endif %}">
                    <label for="id_email" class="form-label">Correo Electr√≥nico</label>
                    <div class="form-input-wrapper">
                        {{ form.email }}
                        <span class="form-icon">üìß</span>
                    </div>
                    {% if form.email.errors %}
                        {% for error in form.email.errors %}
                            <span class="form-error-message">{{ error }}</span>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- Password Field -->
                <div class="form-group {% if form.password1.errors %}has-error{% endif %}">
                    <label for="id_password1" class="form-label">Contrase√±a</label>
                    <div class="form-input-wrapper">
                        {{ form.password1 }}
                        <span class="form-icon password-toggle" id="togglePassword1">üîí</span>
                    </div>
                    {% if form.password1.errors %}
                        {% for error in form.password1.errors %}
                            <span class="form-error-message">{{ error }}</span>
                        {% endfor %}
                    {% else %}
                        <div class="password-requirements">
                            <strong>Tu contrase√±a debe contener:</strong>
                            <ul>
                                <li>Al menos 8 caracteres</li>
                                <li>Debe contener letras y n√∫meros</li>
                                <li>No puede ser muy similar a tu informaci√≥n personal</li>
                            </ul>
                        </div>
                    {% endif %}
                </div>

                <!-- Confirm Password Field -->
                <div class="form-group {% if form.password2.errors %}has-error{% endif %}">
                    <label for="id_password2" class="form-label">Confirmar Contrase√±a</label>
                    <div class="form-input-wrapper">
                        {{ form.password2 }}
                        <span class="form-icon password-toggle" id="togglePassword2">üîí</span>
                    </div>
                    {% if form.password2.errors %}
                        {% for error in form.password2.errors %}
                            <span class="form-error-message">{{ error }}</span>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- Terms and Conditions -->
                <div class="form-checkbox-group">
                    <input type="checkbox" id="terms" name="terms" class="form-checkbox" required>
                    <label for="terms" class="form-checkbox-label">
                        Acepto los t√©rminos y condiciones
                    </label>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn-submit" id="submitBtn">
                    Crear Cuenta
                </button>
            </form>

            <!-- Divider -->
            <div class="auth-divider">
                <span class="auth-divider-text">o</span>
            </div>

            <!-- Login Link -->
            <div class="auth-alternate">
                ¬øYa tienes una cuenta? 
                <a href="{% url 'login' %}" class="auth-link">Inicia sesi√≥n aqu√≠</a>
            </div>

            <!-- Back to Home -->
            <div class="auth-links" style="margin-top: 1rem;">
                <a href="{% url 'inicio' %}" class="auth-link">‚Üê Volver al inicio</a>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Add proper attributes to form inputs
            const usernameInput = document.getElementById('id_username');
            const emailInput = document.getElementById('id_email');
            const password1Input = document.getElementById('id_password1');
            const password2Input = document.getElementById('id_password2');

            // Set input attributes
            if (usernameInput) {
                usernameInput.className = 'form-input';
                usernameInput.placeholder = 'Elige un nombre de usuario';
                usernameInput.required = true;
                usernameInput.autofocus = true;
            }

            if (emailInput) {
                emailInput.className = 'form-input';
                emailInput.type = 'email';
                emailInput.placeholder = 'tu@email.com';
                emailInput.required = true;
            }

            if (password1Input) {
                password1Input.className = 'form-input';
                password1Input.type = 'password';
                password1Input.placeholder = 'Crea una contrase√±a segura';
                password1Input.required = true;
            }

            if (password2Input) {
                password2Input.className = 'form-input';
                password2Input.type = 'password';
                password2Input.placeholder = 'Confirma tu contrase√±a';
                password2Input.required = true;
            }

            // Password toggle functionality
            function setupPasswordToggle(inputId, toggleId) {
                const input = document.getElementById(inputId);
                const toggle = document.getElementById(toggleId);
                
                if (input && toggle) {
                    toggle.style.cursor = 'pointer';
                    toggle.addEventListener('click', function() {
                        if (input.type === 'password') {
                            input.type = 'text';
                            toggle.textContent = 'üîì';
                        } else {
                            input.type = 'password';
                            toggle.textContent = 'üîí';
                        }
                    });
                }
            }

            setupPasswordToggle('id_password1', 'togglePassword1');
            setupPasswordToggle('id_password2', 'togglePassword2');

            // Password indicator
            if (password1Input) {
                password1Input.addEventListener('input', function () {
                    const password = this.value;
                    const requirements = document.querySelector('.password-requirements');
                    if (!requirements) return;

                    const items = requirements.querySelectorAll('li');

                    const okColor = '#10b981';   // verde
                    const badColor = '#ef4444';  // rojo

                    const pwd = password.trim();
                    const hasValue = pwd.length > 0;

                    // Helpers
                    const hasLetter = /[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë]/.test(pwd);
                    const hasDigit  = /\d/.test(pwd);

                    // ===== Regla 1: Al menos 8 caracteres =====
                    if (items[0]) {
                        const ok = pwd.length >= 8;
                        items[0].style.color = hasValue ? (ok ? okColor : badColor) : '';
                        items[0].style.fontWeight = ok ? '700' : '';
                    }

                    // ===== Regla 2: Debe tener letras Y n√∫meros (AMBAS) =====
                    // (Esto reemplaza tu intenci√≥n: rojo si solo letras o solo n√∫meros, verde si mezcla)
                    if (items[1]) {
                        const ok = hasValue && hasLetter && hasDigit;
                        items[1].style.color = hasValue ? (ok ? okColor : badColor) : '';
                        items[1].style.fontWeight = ok ? '700' : '';
                    }

                    // ===== Regla 3: No puede ser muy similar a tu info personal =====
                    // Nota: esto es SOLO una gu√≠a en frontend. La validaci√≥n real la hace Django en el servidor.
                    if (items[2]) {
                        const username = (document.getElementById('id_username')?.value || '').trim().toLowerCase();
                        const email = (document.getElementById('id_email')?.value || '').trim().toLowerCase();
                        const emailUser = email.includes('@') ? email.split('@')[0] : email;

                        const passLower = pwd.toLowerCase();

                        // tokens personales relevantes (solo los que tengan 3+ chars para evitar falsos positivos)
                        const personalTokens = [username, emailUser].filter(t => t && t.length >= 3);

                        // "similar" si contiene username/emailUser o si es igual a alguno
                        const isSimilar = personalTokens.some(t => passLower === t || passLower.includes(t));

                        const ok = hasValue && !isSimilar;
                        items[2].style.color = hasValue ? (ok ? okColor : badColor) : '';
                        items[2].style.fontWeight = ok ? '700' : '';
                    }
                });
            }
            // Password match validation
            if (password2Input) {
                password2Input.addEventListener('input', function() {
                    if (password1Input && this.value && password1Input.value !== this.value) {
                        this.style.borderColor = '#ef4444';
                    } else if (this.value && password1Input.value === this.value) {
                        this.style.borderColor = '#10b981'; // 
                    }
                });
            }

            // Form submission
            const form = document.getElementById('registrationForm');
            const submitBtn = document.getElementById('submitBtn');
            
            if (form) {
                form.addEventListener('submit', function(e) {
                    submitBtn.classList.add('loading');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creando cuenta...';
                });
            }
        });

        // Auto-dismiss error messages after 5 seconds
        setTimeout(function() {
            const errorMessages = document.querySelectorAll('.error-message');
            errorMessages.forEach(function(message) {
                message.style.animation = 'fadeOut 0.5s ease forwards';
                setTimeout(function() {
                    message.remove();
                }, 500);
            });
        }, 5000);
    </script>

    <style>
        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }
    </style>

</body>

</html>
