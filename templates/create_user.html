{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/modern_base.css' %}">
    <link rel="stylesheet" href="{% static 'css/modern_auth.css' %}">
    <title>Crear Usuario - BuFuu GrowShop</title>
</head>

<body>
    <div class="auth-page">
        <div class="auth-container" style="max-width: 520px;">
            <!-- Logo Section -->
            <div class="auth-logo">
                <div class="auth-logo-img" style="font-size: 4rem;">
                    {% if can_create_admin %}üëë{% else %}üë§{% endif %}
                </div>
                <h1 class="auth-title">Crear Nuevo Usuario</h1>
                <p class="auth-subtitle">
                    {% if can_create_admin %}
                        Puedes crear Admin o Staff
                    {% else %}
                        Crear cuenta de Staff
                    {% endif %}
                </p>
            </div>

            <!-- Info Alert -->
            <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                <strong>‚ÑπÔ∏è Tu rol:</strong> {{ user_profile.get_role_display|upper }}
            </div>

            <!-- Error Messages -->
            {% if form.non_field_errors %}
                <div class="error-message">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Create User Form -->
            <form method="post" class="auth-form" id="createUserForm">
                {% csrf_token %}
                
                <!-- Username Field -->
                <div class="form-group {% if form.username.errors %}has-error{% endif %}">
                    <label for="id_username" class="form-label">Nombre de Usuario</label>
                    <div class="form-input-wrapper">
                        {{ form.username }}
                        <span class="form-icon">üë§</span>
                    </div>
                    {% if form.username.errors %}
                        {% for error in form.username.errors %}
                            <span class="form-error-message">{{ error }}</span>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- Email Field -->
                <div class="form-group {% if form.email.errors %}has-error{% endif %}">
                    <label for="id_email" class="form-label">Correo Electr√≥nico</label>
                    <div class="form-input-wrapper">
                        {{ form.email }}
                        <span class="form-icon">üìß</span>
                    </div>
                    {% if form.email.errors %}
                        {% for error in form.email.errors %}
                            <span class="form-error-message">{{ error }}</span>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- Name Fields Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <!-- First Name -->
                    <div class="form-group {% if form.first_name.errors %}has-error{% endif %}">
                        <label for="id_first_name" class="form-label">Nombre</label>
                        {{ form.first_name }}
                        {% if form.first_name.errors %}
                            {% for error in form.first_name.errors %}
                                <span class="form-error-message">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <!-- Last Name -->
                    <div class="form-group {% if form.last_name.errors %}has-error{% endif %}">
                        <label for="id_last_name" class="form-label">Apellido</label>
                        {{ form.last_name }}
                        {% if form.last_name.errors %}
                            {% for error in form.last_name.errors %}
                                <span class="form-error-message">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <!-- Role Selection (Only for Superusers) -->
                {% if can_create_admin %}
                <div class="form-group">
                    <label class="form-label">Rol del Usuario:</label>
                    <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 0.75rem;">
                        <label style="display: flex; align-items: start; gap: 0.75rem; padding: 1rem; border: 2px solid var(--border-color); border-radius: 0.75rem; cursor: pointer; transition: all 0.2s ease;">
                            <input type="radio" name="role" value="staff" checked style="margin-top: 0.25rem;">
                            <div>
                                <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 0.25rem;">
                                    üü¢ Staff
                                </div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                    Acceso b√°sico al sistema. Puede gestionar productos y ver informaci√≥n.
                                </div>
                            </div>
                        </label>
                        
                        <label style="display: flex; align-items: start; gap: 0.75rem; padding: 1rem; border: 2px solid var(--border-color); border-radius: 0.75rem; cursor: pointer; transition: all 0.2s ease;">
                            <input type="radio" name="role" value="admin" style="margin-top: 0.25rem;">
                            <div>
                                <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 0.25rem;">
                                    üü£ Admin
                                </div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                    Puede crear cuentas de Staff y gestionar usuarios b√°sicos.
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
                {% endif %}

                <!-- Password Field -->
                <div class="form-group {% if form.password1.errors %}has-error{% endif %}">
                    <label for="id_password1" class="form-label">Contrase√±a</label>
                    <div class="form-input-wrapper">
                        {{ form.password1 }}
                        <span class="form-icon password-toggle" id="togglePassword1">üîí</span>
                    </div>
                    {% if form.password1.errors %}
                        {% for error in form.password1.errors %}
                            <span class="form-error-message">{{ error }}</span>
                        {% endfor %}
                    {% else %}
                        <div class="password-requirements">
                            <strong>Requisitos de contrase√±a:</strong>
                            <ul>
                                <li>Al menos 8 caracteres</li>
                                <li>No puede ser completamente num√©rica</li>
                                <li>No puede ser muy com√∫n</li>
                            </ul>
                        </div>
                    {% endif %}
                </div>

                <!-- Confirm Password Field -->
                <div class="form-group {% if form.password2.errors %}has-error{% endif %}">
                    <label for="id_password2" class="form-label">Confirmar Contrase√±a</label>
                    <div class="form-input-wrapper">
                        {{ form.password2 }}
                        <span class="form-icon password-toggle" id="togglePassword2">üîí</span>
                    </div>
                    {% if form.password2.errors %}
                        {% for error in form.password2.errors %}
                            <span class="form-error-message">{{ error }}</span>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn-submit" id="submitBtn">
                    Crear Usuario
                </button>
            </form>

            <!-- Back Links -->
            <div class="auth-links" style="margin-top: 1.5rem;">
                <a href="{% url 'admin_dashboard' %}" class="auth-link">‚Üê Volver al Panel</a>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Password toggle functionality
            function setupPasswordToggle(inputId, toggleId) {
                const input = document.getElementById(inputId);
                const toggle = document.getElementById(toggleId);
                
                if (input && toggle) {
                    toggle.style.cursor = 'pointer';
                    toggle.addEventListener('click', function() {
                        if (input.type === 'password') {
                            input.type = 'text';
                            toggle.textContent = 'üîì';
                        } else {
                            input.type = 'password';
                            toggle.textContent = 'üîí';
                        }
                    });
                }
            }

            setupPasswordToggle('id_password1', 'togglePassword1');
            setupPasswordToggle('id_password2', 'togglePassword2');

            // Role radio button styling
            const roleInputs = document.querySelectorAll('input[name="role"]');
            roleInputs.forEach(input => {
                const label = input.parentElement;
                
                input.addEventListener('change', function() {
                    // Remove active state from all
                    roleInputs.forEach(r => {
                        r.parentElement.style.borderColor = 'var(--border-color)';
                        r.parentElement.style.background = 'white';
                    });
                    
                    // Add active state to selected
                    if (this.checked) {
                        label.style.borderColor = 'var(--primary-color)';
                        label.style.background = 'rgba(16, 185, 129, 0.05)';
                    }
                });
                
                // Set initial state
                if (input.checked) {
                    label.style.borderColor = 'var(--primary-color)';
                    label.style.background = 'rgba(16, 185, 129, 0.05)';
                }
            });

            // Password strength indicator
            const password1Input = document.getElementById('id_password1');
            if (password1Input) {
                password1Input.addEventListener('input', function() {
                    const password = this.value;
                    const requirements = document.querySelector('.password-requirements');
                    
                    if (requirements) {
                        const items = requirements.querySelectorAll('li');
                        
                        if (items[0]) {
                            items[0].style.color = password.length >= 8 ? '#10b981' : '';
                            items[0].style.fontWeight = password.length >= 8 ? '700' : '';
                        }
                        
                        if (items[1]) {
                            items[1].style.color = !/^\d+$/.test(password) ? '#10b981' : '';
                            items[1].style.fontWeight = !/^\d+$/.test(password) ? '700' : '';
                        }
                    }
                });
            }

            // Password match validation
            const password2Input = document.getElementById('id_password2');
            if (password2Input && password1Input) {
                password2Input.addEventListener('input', function() {
                    if (this.value && password1Input.value !== this.value) {
                        this.style.borderColor = '#ef4444';
                    } else if (this.value && password1Input.value === this.value) {
                        this.style.borderColor = '#10b981';
                    }
                });
            }

            // Form submission
            const form = document.getElementById('createUserForm');
            const submitBtn = document.getElementById('submitBtn');
            
            if (form) {
                form.addEventListener('submit', function(e) {
                    submitBtn.classList.add('loading');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creando usuario...';
                });
            }
        });

        // Auto-dismiss error messages
        setTimeout(function() {
            const errorMessages = document.querySelectorAll('.error-message');
            errorMessages.forEach(function(message) {
                message.style.animation = 'fadeOut 0.5s ease forwards';
                setTimeout(function() {
                    message.remove();
                }, 500);
            });
        }, 5000);
    </script>

    <style>
        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }
    </style>

</body>

</html>